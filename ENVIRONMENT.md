# Environment configuration

Profit Pulse validates a small set of core variables on startup and conditionally enables integrations when optional variables are present. Use this guide to understand what each value controls and when it is required.

## Runtime environments

- `APP_ENV` (preferred) or `NODE_ENV` determines whether the app is running in production. Production mode disables all fallbacks and will abort startup if any required variable is missing.
- Development-only fallbacks exist for `SHOPIFY_API_KEY`, `SHOPIFY_API_SECRET`, `SHOPIFY_APP_URL`, and `SCOPES`. When they are used, a console warning is emitted so you can fill the real values locally.
- `validateRequiredEnv()` executes during server startup to prevent “sick” deployments: missing Shopify secrets, database URLs, encryption keys, and the OAuth state secret (production) will throw immediately.

## Core requirements

| Variable | Required | Description |
| --- | --- | --- |
| `SHOPIFY_API_KEY` | ✅ | Public app client ID used for OAuth and embedded app bridge. |
| `SHOPIFY_API_SECRET` | ✅ | App secret from the Shopify Partner Dashboard. Used for OAuth, webhook validation, and OAuth state fallback. |
| `SHOPIFY_APP_URL` | ✅ | Public HTTPS base URL that Shopify will call during auth, webhooks, and background jobs. |
| `SCOPES` | ✅ | Comma-separated list of Admin API scopes requested on install (e.g. `read_orders,read_products`). |
| `DATABASE_URL` | ✅ | Prisma connection string (PostgreSQL recommended). |
| `CREDENTIAL_ENCRYPTION_KEY` | ✅ | 32-byte secret used to encrypt third-party credentials at rest. |
| `OAUTH_STATE_SECRET` | ✅ (production) | Secret used to sign OAuth state. Required in production; development falls back to `SHOPIFY_API_SECRET`, but do not rely on defaults outside local dev. |
| `SHOP_CUSTOM_DOMAIN` | ⚠️ | If set, restricts installs to a single custom shop domain. Useful for pilot rollouts. |

## Privacy & retention

| Variable | Required | Description |
| --- | --- | --- |
| `RETENTION_CRON_SECRET` | ⚠️ | Bearer token for calling `/internal/retention/cleanup` when scheduling the uninstall data purge job. Defaults to `SHOPIFY_API_SECRET` if unset. |

## Background sync tuning

| Variable | Required | Description |
| --- | --- | --- |
| `ORDER_SYNC_CONCURRENCY` | ⚠️ | Maximum number of Shopify orders processed in parallel during backfills. Defaults to 5. |
| `CREDENTIAL_REFRESH_CONCURRENCY` | ⚠️ | Upper bound on parallel ad credential refreshes. Defaults to 5. |
| `PAYOUT_SYNC_CONCURRENCY` | ⚠️ | Caps the number of simultaneous payout upserts when syncing PayPal settlements. Defaults to 5 with a hard ceiling of 10. |

## Caching

No external cache is configured. The app uses an in-process memoization Map suitable for single-instance deployments. If you add a distributed cache in the future, wire it in `app/services/cache.server.js`.

## Exchange rates

| Variable | Required | Description |
| --- | --- | --- |
| `EXCHANGE_RATE_API_URL` | ⚠️ | Optional override for the FX provider endpoint. Defaults to the bundled open API. |
| `EXCHANGE_RATE_API_KEY` | ⚠️ | API key for the configured FX provider. Required if the provider needs authentication. |

## Advertising integrations

| Variable | Required | Description |
| --- | --- | --- |
| `META_ADS_APP_ID` | ⚠️ | Meta Ads application ID. |
| `META_ADS_APP_SECRET` | ⚠️ | Meta Ads application secret used during token exchange. |

## Payment provider integrations

| Variable | Required | Description |
| --- | --- | --- |
| `PAYPAL_CLIENT_ID` | ⚠️ | PayPal REST client ID for payout sync. |
| `PAYPAL_CLIENT_SECRET` | ⚠️ | PayPal REST client secret. |
| `PAYPAL_API_BASE_URL` | ⚠️ | Optional override for PayPal API base (defaults to `https://api-m.paypal.com`). |

## Billing & monetization

| Variable | Required | Description |
| --- | --- | --- |
| `SHOPIFY_BILLING_TEST_MODE` | ⚠️ | When set to `true`, enables Shopify billing test mode to avoid live charges during development. |
| `ALLOW_INACTIVE_SUBSCRIPTIONS` | ⚠️ | Set to `true` only in trials/PoC environments to bypass subscription status checks; defaults to strict enforcement. |
| `PLAN_OVERAGE_ALERT_RECIPIENTS` | ⚠️ | Comma-separated email list to notify when plan limits are hit. Uses `PROFIT_PULSE_EMAIL_ENDPOINT` if configured; otherwise logs locally. |

## Seed & demo data

| Variable | Required | Description |
| --- | --- | --- |
| `SEED_SHOP_DOMAIN` | ⚠️ | Development convenience for the Prisma seed script. Defaults to `northwind-apparel.myshopify.com`. |
| `SEED_METRIC_DAYS` | ⚠️ | Number of daily metric rows generated by the seed script. Defaults to 30. |

## Operational tips

- Keep secrets (API keys, encryption key, OAuth secrets) out of version control. Use your hosting provider's secret manager.
- Subscription status is enforced before counting orders; only use `ALLOW_INACTIVE_SUBSCRIPTIONS=true` if you intentionally want to keep syncing during a trial.
- Configure `PLAN_OVERAGE_ALERT_RECIPIENTS` (and `PROFIT_PULSE_EMAIL_ENDPOINT` if you have one) to receive notifications when merchants hit plan limits.
- Set `OAUTH_STATE_SECRET` in production to a high-entropy value; never rely on the development fallback when running a deployed instance.
- Keep Meta Ads and PayPal variables scoped to each environment; restarting the app refreshes tokens if credentials become invalid.
- For multi-instance deployments, consider swapping `app/services/cache.server.js` to a shared cache so memoized values stay consistent; the default in-process cache is suited to single-node setups.
- Run `npm test` locally (or `node --test`) to verify profit engine and reporting logic whenever you touch services. The suites rely on the same `.env` configuration as `npm run dev`, so make sure the keys above are populated first.
- Seed demo data from the Settings page (“Seed demo costs”) after installing the embedded app on a development store—this loads SKU costs so dashboards/product tables light up immediately.

## First-time developer & testing flow

1. Copy `.env.example` to `.env` and fill the mandatory keys (`SHOPIFY_API_KEY`, `SHOPIFY_API_SECRET`, `SHOPIFY_APP_URL`, `SCOPES`, `DATABASE_URL`, and `CREDENTIAL_ENCRYPTION_KEY`). Optional integrations (Meta Ads, PayPal) can be added later.
2. Run `npm install` (requires network access) and `npx prisma migrate deploy` to prepare the database.
3. Start the embedded app with `npm run dev` via the Shopify CLI, install it on a development store, and complete the onboarding checklist (connect Meta Ads, import/seed COGS).
4. Use the Settings page “Seed demo costs” button to hydrate SKU costs, then verify dashboards/orders/products have data.
5. Execute `npm test` before pushing changes to ensure profit engine, reconciliation, and reporting suites pass.
